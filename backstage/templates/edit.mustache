<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        {{> bulma.css}}
    </style>
    <style>
        nav {
            margin-top: 1em;
            margin-bottom: 1em;
        }

        textarea, input[name="slug"], form, form button {
            font-size: 1em;
            font-family: "SF Mono", "Menlo-Regular", Consolas, "Andale Mono WT",
            "Andale Mono", "Lucida Console", "Lucida Sans Typewriter",
            "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono",
            "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
        }

        iframe {
            min-height: 40vh;
            border: 1px solid gray;
        }
    </style>
</head>
<body class="container is-fluid" style="margin: 1em 1em 80px 1em">
    <nav style="display: flex; justify-content: space-between;">
        <a href="/backstage" class="button">&larr; backstage</a>
        {{#post}}
            <div class="field has-addons">
                {{#draft}}
                    <div class="control">
                        <button type="submit"
                            formaction="/backstage/delete/"
                            class="control button"
                            onclick="return confirm('delete {{id}}?')"
                            form="main-form"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 448 512">
                                <path fill="currentColor" d="{{fas.trash}}"></path>
                            </svg>
                        </button>
                    </div>
                {{/draft}}
                <div class="control">
                    <button type="submit"
                        name="draft"
                        value="1"
                        class="button"
                        form="main-form"
                    >
                        {{#draft}}draft{{/draft}}
                        {{^draft}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 576 512">
                                <path fill="currentColor" d="{{ fas.eye-slash }}"></path>
                            </svg>
                        {{/draft}}
                    </button>
                </div>
                <div class="control">
                    <button type="submit"
                        name="private"
                        value="1"
                        class="button"
                        form="main-form"
                    >
                        {{#private}}private{{/private}}
                        {{^private}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 512 512">
                                <path fill="currentColor" d="{{ fas.shield-alt }}"></path>
                            </svg>
                        {{/private}}
                    </button>
                </div>
                <div class="control">
                    <button type="submit"
                        name="public"
                        value="1"
                        class="button"
                        form="main-form"
                    >
                        {{#public}}public{{/public}}
                        {{^public}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 576 512">
                                <path fill="currentColor" d="{{fas.newspaper}}"></path>
                            </svg>
                        {{/public}}
                    </button>
                </div>
            </div>
        {{/post}}
    </nav>
    <form method="POST" id="main-form">
        <input type="hidden" name="id" value="{{post.id}}">
        <div
            {{#post.slug}}
                class="field is-horizontal has-addons"
            {{/post.slug}}
            {{^post.slug}}
                class="field is-horizontal"
            {{/post.slug}}
        >
            <div class="control" style="width: 100%; flex-grow: 1;">
                <input
                    name="slug"
                    pattern="[a-zA-Z0-9_-]+"
                    value="{{post.slug}}"
                    placeholder="/slug"
                    class="input"
                    style="width: 100%; flex-grow: 1;"
                >
                <p class="help has-text-right">
                    <a href="/{{post.id}}.html" target="_blank" class="has-text-grey-light is-size-7">
                        /{{post.id}}.html
                    </a>
                </p>
            </div>
            {{#post.slug}}
                <div class="control">
                    <a href="/{{post.slug}}.html" target="_blank" class="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 576 512">
                            <path fill="currentColor" d="{{fas.link}}"></path>
                        </svg>
                    </a>
                </div>
            {{/post.slug}}
        </div>
        <textarea
            name="text"
            placeholder="markdown text"
            class="field textarea"
            rows="8"
        >{{{post.text}}}</textarea>
        <div class="field is-horizontal"
            style="justify-content: space-between; display: flex; flex-flow: row wrap"
        >
            <div class="field has-addons">
                <div class="control">
                <input
                    type="datetime-local"
                    name="created"
                    value="{{post.created}}"
                    class="input"
                    pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}"
                />
                </div>
                <div class="control">
                    <button type="button"
                        class="button"
                        onclick='document.querySelector("form#main-form").created.value = new Date().toISOString().replace(/:\d{2}\.\d{3}Z$/, "")'
                    >now</button>
                </div>
            </div>
            <div class="tabs">
                <ul>
                    <li>
                        <button type="submit"
                            formtarget="preview"
                            formaction="/backstage/preview/"
                            style="border: none; background: none;"
                            onclick="window.tabClick(event)"
                            name="teaser"
                            value="1" 
                        >
                            <a>teaser</a>
                        </button>
                    </li>
                    <li>
                        <button type="submit"
                            formtarget="preview"
                            formaction="/backstage/preview/"
                            style="border: none; background: none;"
                            onclick="window.tabClick(event)"
                        >
                            <a>preview</a>
                        </button>
                    </li>
                    <li>
                        <button type="submit"
                            formtarget="preview"
                            formaction="/backstage/media/"
                            formmethod="GET"
                            form="dummy"
                            style="border: none; background: none;"
                            onclick="window.tabClick(event)"
                        >
                            <a>media</a>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </form>
    <iframe name="preview"
        width="100%"
        frameborder="0"
    ></iframe>
    <form id="dummy"></form>
    <script>
        /* eslint-env browser */
        window.appendText = function (text) {
            const textarea = document.querySelector('textarea[name="text"]')
            textarea.innerText = (textarea.innerText + ' ' + text.trim()).trim()

            textarea.focus()
            textarea.selectionStart = textarea.innerText.length
            textarea.selectionEnd = textarea.innerText.length
        }

        window.tabClick = function (event) {
            for (const tab of event.target.closest(".tabs").querySelectorAll("li")) {
                tab.classList[tab.contains(event.currentTarget) ? "add" : "remove"]("is-active");
            }

            return true;
        }
    </script>
</body>
</html>
