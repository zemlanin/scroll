<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        {{> bulma.css}}
    </style>
    <style>
      * {
        box-sizing: border-box;
      }

      nav {
        margin-top: 1em;
        margin-bottom: 1em;
      }

      textarea,
      input[name="slug"]{
        width: 100%;
        font-size: 1em;
        font-family: "SF Mono", "Menlo-Regular", Consolas, "Andale Mono WT",
          "Andale Mono", "Lucida Console", "Lucida Sans Typewriter",
          "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono",
          "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
      }

      textarea {
        min-height: 40vh;
      }

      section {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        margin-bottom: 64px;
      }

      section .media-thumbnail,
      section .more-media {
        width: 64px;
        height: 64px;
        background: lightgray;
        word-break: all;
        margin: 2px;
      }

      section .more-media {
        flex-grow: 1;
      }
    </style>
</head>
<body class="container is-fluid" style="margin-top: 1em; margin-bottom: 80px">
    <nav class="level">
      <div class="level-left">
        <a class="button" href="/backstage">&larr; backstage</a>
      </div>
      <form enctype="multipart/form-data"
        action="/backstage/media/"
        method="POST"
        class="field has-addons level-right"
      >
        <div class="control is-expanded">
          <input name="files" type="file" multiple class="input" />
        </div>
        <div class="control">
          <button class="button">+</button>
        </div>
      </form>
    </nav>

    <section>
      {{#media}}
        <a
          class="media-thumbnail"
          target="_blank"
          href="/media/{{id}}.{{ext}}"
          data-id="{{id}}"
          {{#type.image}}data-type="image"{{/type.image}}
          {{#type.video}}data-type="video"{{/type.video}}
          {{#type.audio}}data-type="audio"{{/type.audio}}
          {{#type.text}}data-type="text"{{/type.text}}
          {{#type.image}}
            style="background-image: url('/media/{{id}}.{{ext}}?w=128&h=128'); background-size: cover;"
          {{/type.image}}
          onclick="window.expandMedia(event, this)"
        >
            {{^type.image}}{{ext}}{{/type.image}}
        </a>
      {{/media}}
      {{#urls.moreMedia}}
        <div class="more-media" onclick="window.loadMore(this)" data-src="{{urls.moreMedia}}">
           ...
        </div>
      {{/urls.moreMedia}}
    </section>
    <script>
      /* eslint-env browser */
      if (window.top != window) {
        document.querySelector('nav').hidden = true;
      }

      window.loadMore = function(el) {
        const parent = el.parentNode;
        const url = el.dataset.src;
        fetch(url, { credentials: "include" })
          .then(async r => {
            const htmlTag = document.createElement("html");
            htmlTag.innerHTML = await r.text();
            for (const div of htmlTag.querySelectorAll(
              "section .media-thumbnail, section .more-media"
            )) {
              parent.appendChild(div);
            }
            parent.removeChild(el);
          })
          .catch(e => {
            el.innerText = e.toString();
          });
      };

      window.expandMedia = function(event, el) {
        event.preventDefault();
        location.href = "/backstage/media/?id=" + el.dataset.id;
        return;
      };
    </script>
</body>
</html>
